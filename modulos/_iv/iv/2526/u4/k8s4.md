---
title:  Trabajando con Deployments
---

## Deployment

Resumen en forma de lista:

* **Deployment**:

  * Es el **recurso de más alto nivel** que se gestiona habitualmente en Kubernetes.
  * Es el recurso que se utiliza para **desplegar aplicaciones**, en lugar de trabajar directamente con Pods o ReplicaSets.

* **Relación con Pods y ReplicaSet**:

  * Al crear un **Deployment**:

    * Kubernetes crea automáticamente un **ReplicaSet**.
    * El ReplicaSet controla un conjunto de **Pods** creados a partir de una imagen concreta.
  * El usuario **no gestiona directamente** Pods ni ReplicaSets:

    * El Deployment actúa como capa de abstracción superior.

* **Gestión de versiones y actualizaciones**:

  * Al cambiar la **versión de la imagen** en el Deployment:

    * Se crea un **nuevo ReplicaSet**.
    * Este ReplicaSet gestiona Pods con la **nueva versión de la aplicación**.
  * El Deployment mantiene un **historial de ReplicaSets**:

    * Cada uno asociado a una versión distinta de la imagen.
  * El ReplicaSet activo es el responsable de ejecutar la **versión actual** de la aplicación.

* **Rollback**:

  * Gracias al historial de ReplicaSets:

    * Es posible volver de forma sencilla a una **versión anterior de la aplicación**.
    * Esta operación se conoce como **rollback**.

* **Funciones principales de un Deployment**:

  * Control del número de réplicas.
  * Escalabilidad de Pods.
  * Actualizaciones continuas (rolling updates).
  * Despliegues automáticos.
  * Rollback a versiones anteriores.

* **Arquitectura de aplicaciones en Kubernetes**:

  * **Aplicaciones con varios servicios**:

    * Cada servicio se despliega con un **Deployment independiente**.
    * Ejemplo: aplicación PHP + base de datos → dos Deployments.
  * **Aplicaciones basadas en microservicios**:

    * Cada microservicio se despliega de forma autónoma.
    * Se crea un **Deployment por microservicio**.
    * Ejemplo: frontend que consume un backend vía API RESTful.


## Describiendo un Deployment

Podemos crear un Deployment de forma imperativa utilizando un comando como el siguiente (se podrían indicar muchos más parámetros de configuración que podemos consultar en la documentación):

    kubectl create deployment nginx --image nginx

Nosotros, sin embargo, vamos a seguir describiendo los recursos en un fichero yaml. En este caso para describir un Deployment de nginx podemos escribir un fichero `nginx-deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-nginx
  labels:
    app: nginx
spec:
  revisionHistoryLimit: 2
  strategy:
    type: RollingUpdate
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx
        name: contendor-nginx
        ports:
        - name: http
          containerPort: 80
```

La creación de un Deployment crea un ReplicaSet y los Pods correspondientes. Por lo tanto en la definición de un Deployment se define también el ReplicaSet asociado (los parámetros `replicas`, `selector` y `template`). Los atributos relacionados con el Deployment que hemos indicado en la definición son:

* `revisionHistoryLimit`: Indicamos cuántos ReplicaSets antiguos deseamos conservar, para poder realizar rollback a estados anteriores. Por defecto, es 10.
* `strategy`: Indica el modo en que se realiza una actualización del Deployment. Es decir, cuando modificamos la versión de la imagen del Deployment, se crea un ReplicaSet nuevo y ¿qué hacemos con los pods?:
    * `Recreate`: elimina los Pods antiguos y crea los nuevos.
    * `RollingUpdate`: va creando los nuevos Pods, comprueba que funcionan y se eliminan los antiguos; es la opción por defecto.

Además, hemos introducido un nuevo parámetro al definir el contenedor del pod: con el parámetro `ports` hemos indicado el puerto que expone el contenedor (`containerPort`) y le hemos asignado un nombre (`name`).

### Vídeo

[https://www.youtube.com/watch?v=NBsc_fILt8g](https://www.youtube.com/watch?v=NBsc_fILt8g)

## Gestionando los Deployment

En esta unidad vamos a trabajar con el recurso Deployment, vamos a crear un Deployment de un servidor nginx, usando el fichero yaml que hemos visto en la unidad anterior: [`nginx-deployment.yaml`](files/nginx-deployment.yaml).

### Creación del Deployment

Cuando creamos un Deployment, se creará un ReplicaSet asociado, que creará y controlará los Pods que hayamos indicado.

    kubectl apply -f nginx-deployment.yaml
    kubectl get deploy,rs,pod

Para ver los recursos que hemos creado también podemos utilizar la instrucción:

    kubectl get all

Esta orden muestra los Deployments, ReplicaSets, Pods y Services que tenemos creados en el cluster. Los Services lo estudiaremos en el siguiente módulo.

### Escalado de los Deployments

Como ocurría con los ReplicaSets los Deployment también se pueden escalar, aumentando o disminuyendo el número de Pods asociados. Al escalar un Deployment estamos escalando el ReplicaSet asociado en ese momento:

    kubectl scale deployment deployment-nginx --replicas=4

### Otras operaciones

Si queremos acceder a la aplicación, podemos utilizar la opción de `port-forward` sobre el despliegue (de nuevo recordamos que no es la forma adecuada para acceder a un servicio que se ejecuta en un Pod, pero de momento no tenemos otra). En este caso si tenemos asociados más de un Pod, la redirección de puertos se hará sobre un solo Pod (no habrá balanceo de carga):

    kubectl port-forward deployment/deployment-nginx 8080:80

Si queremos ver los logs generados en los Pods de un Deployment:

    kubectl logs deployment/deployment-nginx

Si queremos obtener información detallada del recurso Deployment que hemos creado:

    kubectl describe deployment/deployment-nginx

### Eliminando el Deployment

Si eliminamos el Deployment se eliminarán el ReplicaSet asociado y los Pods que se estaban gestionando.

    kubectl delete deployment deployment-nginx

### Vídeo

[https://www.youtube.com/watch?v=dcKWO6gXhhs](https://www.youtube.com/watch?v=dcKWO6gXhhs)

{% capture notice-text %}
## Ejercicio

Vamos a crear un Deployment de una aplicación web. Sigamos los siguientes pasos:

1. Crea un fichero yaml con la descripción del recurso Deployment, teniendo en cuenta los siguientes aspectos:
    * Indica nombres distintos para el Deployment y para el contenedor de los Pods que va a controlar.
    * El Deployment va a crear 2 réplicas.
    * La imagen que debes desplegar es `iesgn/test_web:latest`.
    * Indica de manera adecuada una etiqueta en la especificación del Pod que vas a definir que coincida con el *selector* del Deployment.
2. Crea el Deployment.
3. Comprueba los recursos que se han creado: Deployment, ReplicaSet y Pods.
4. Obtén información detallada del Deployment creado.
5. Crea un una redirección utilizando el `port-forward` para acceder a la aplicación, sabiendo que la aplicación ofrece el servicio en el puerto 80, y accede a la aplicación con un navegador web.
6. Accede  a los logs del despliegue para comprobar el acceso que has hecho en el punto anterior.
7. Elimina el Deployment y comprueba que se han borrado todos los recursos creados.

{% endcapture %}<div class="notice--warning">{{ notice-text | markdownify }}</div>