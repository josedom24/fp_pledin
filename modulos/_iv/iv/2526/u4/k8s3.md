---
title: Trabajando con ReplicaSet
---

## ReplicaSet

* **ReplicaSet**:

  * Es un **recurso de Kubernetes** que asegura que siempre se esté ejecutando un **número concreto de réplicas de un Pod**.
  * Garantiza que un conjunto de Pods esté **activo y disponible**.

* **Características principales**:

  * **Tolerancia a fallos**:

    * Si un Pod se detiene o falla, el ReplicaSet crea uno nuevo.
    * Si un nodo falla, el ReplicaSet intenta recrear los Pods en otros nodos disponibles.
  * **Escalabilidad dinámica**:

    * Permite **aumentar o disminuir** el número de réplicas de un Pod de forma sencilla.

* **Gestión indirecta de Pods**:
  * En Kubernetes **no se trabaja directamente con Pods** de forma habitual.
  * El **ReplicaSet es quien controla el ciclo de vida** de los Pods que gestiona.
  * Se encarga de que los Pods:
    * Estén siempre ejecutándose.
    * Coincidan con el número de réplicas deseado.

* **Distribución en el clúster**:
  * En clústeres con varios nodos:
    * Las réplicas de los Pods se distribuyen entre distintos nodos.
  * En el caso de **Minikube (un solo nodo)**:
    * Todos los Pods se ejecutan en la misma máquina.
    * No se aprecia la distribución entre nodos, aunque el comportamiento lógico es el mismo.

* **Comportamiento ante fallos**:
  * Si un Pod se detiene por cualquier motivo:
    * El ReplicaSet intenta **recrearlo automáticamente**.
  * El objetivo es mantener siempre el **estado deseado** del sistema:
    * El número de Pods definido por el usuario.

## Describiendo un ReplicaSet

En este caso también vamos a definir el recurso de ReplicaSet en un fichero `nginx-rs.yaml`, por ejemplo como este:

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: replicaset-nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - image: nginx
          name: contenedor-nginx
```

Algunos de los parámetros definidos ya lo hemos estudiado en la definición del Pod. Los nuevos parámetros de este recurso son los siguientes:

* `replicas`: Indicamos el número de Pods que siempre se deben estar ejecutando.
* `selector`: Seleccionamos los Pods que va a controlar el ReplicaSet por medio de las etiquetas. Es decir este ReplicaSet controla los Pods cuya etiqueta `app` es igual a `nginx`.
* `template`: El recurso ReplicaSet contiene la definición de un Pod. Fíjate que el Pod que hemos definido en la sección `template` tiene indicado la etiqueta necesaria para que sea seleccionado por el ReplicaSet (`app: nginx`).

### Vídeo

[https://www.youtube.com/watch?v=VL3J63JqV5o](https://www.youtube.com/watch?v=VL3J63JqV5o)

## Gestionando los ReplicaSet

En esta unidad vamos a crear un recurso ReplicaSet que controlará un conjunto de recursos Pods. Para ello vamos a utilizar el fichero que estudiamos en la unidad anterior: [`nginx-rs.yaml`](files/nginx-rs.yaml).

### Creación del ReplicaSet

Aunque en la unidad anterior usamos `kubectl create` para crear los recursos de nuestro cluster, es recomendable usar `kubectl apply`. La diferencia es la forma en la que actuamos sobre el cluster:

* **Configuración imperativa de objetos**: La definición del objeto está guardada en un fichero Yaml y ejecutamos un comando imperativo. Posteriormente no podremos modificar el objeto, habrá que borrarlo y crearlo de nuevo. Ejemplos:

        kubectl create -f recurso.yaml
        kubectl delete -f recurso.yaml

* **Configuración declarativa de objetos**: No se definen las acciones a realizar. Cuando se aplica la configuración del objeto estamos indicando un estado deseado al que queremos llegar. Posteriormente si la definición cambia, podremos cambiar el objeto. Recomendado en producción. Ejemplo:

        kubectl apply -f recurso.yaml

Por lo tanto para crear nuestro ReplicaSet, ejecutamos:

    kubectl apply -f nginx-rs.yaml

Y podemos ver los recursos que se han creado con:

    kubectl get rs,pods

Observamos que queríamos crear 2 replicas del Pod, y efectivamente se han creado.

Si queremos obtener información detallada del recurso ReplicaSet que hemos creado:

    kubectl describe rs replicaset-nginx

### Tolerancia a fallos

Y ahora comenzamos con las funcionalidades llamativas de Kubernetes. ¿Qué pasaría si borro uno de los Pods que se han creado? Inmediatamente se creará uno nuevo para que siempre estén ejecutándose los Pods deseados, en este caso 2:

    kubectl delete pod <nombre_del_pod>
    kubectl get pods

### Escalabilidad

Para escalar el número de pods:

    kubectl scale rs replicaset-nginx --replicas=5
    kubectl get pods

Otra forma de hacerlo sería cambiando el parámetro `replicas` de fichero yaml, y volviendo a ejecutar:

    kubectl apply -f nginx-rs.yaml

La escalabilidad puede ser para aumentar el número de Pods o para reducirla:

    kubectl scale rs replicaset-nginx --replicas=1

### Eliminando el ReplicaSet

Por último, si borramos un ReplicaSet se borrarán todos los Pods asociados:

    kubectl delete rs replicaset-nginx

Otra forma de borrar el recurso, es utilizar el fichero yaml:

    kubectl delete -f nginx-rs.yaml

### Vídeo

[https://www.youtube.com/watch?v=MeCraOsxRPo](https://www.youtube.com/watch?v=MeCraOsxRPo)

{% capture notice-text %}
## Ejercicio

Como indicamos en el contenido de este módulo, no se va  a trabajar directamente con los Pods (realmente tampoco vamos a trabajar directamente con los ReplicaSet, en el siguiente módulo explicaremos los Deployments que serán el recurso con el que trabajaremos).  En este ejercicio vamos a crear un ReplicaSet que va a controlar un conjunto de Pods. Para ello, realiza los siguientes pasos:

1. Crea un fichero yaml con la descripción del recurso ReplicaSet, teniendo en cuenta los siguientes aspectos:
    * Indica nombres distintos para el ReplicaSet y para el contenedor de los Pods que va a controlar.
    * El ReplicaSet va a crear 3 réplicas.
    * La imagen que debes desplegar es `iesgn/test_web:latest`.
    * Indica de manera adecuada una etiqueta en la especificación del Pod que vas a definir que coincida con el *selector* del ReplicaSet.
2. Crea el ReplicaSet.
3. Comprueba que se ha creado el ReplicaSet y los 3 Pods.
4. Obtén información detallada del ReplicaSet creado.
5. Vamos a probar la tolerancia a fallos: Elimina uno de los 3 Pods, y comprueba que inmediatamente se ha vuelto a crear un nuevo Pod.
6. Vamos a comprobar la escalabilidad: escala el ReplicaSet para tener 6 Pods de la aplicación.
7. Elimina el ReplicaSet y comprueba que se han borrado todos los Pods.


{% endcapture %}<div class="notice--warning">{{ notice-text | markdownify }}</div>